<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ChefOS Insights</title>
  <link rel="stylesheet" href="assets/css/styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="app-container">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1><i class="fas fa-chart-bar"></i> ChefOS Insights</h1>
      </div>
      
      <div class="sidebar-nav">
        <div class="nav-section">
          <h3>Menu</h3>
          <ul class="nav-links">
            <li><a href="pos.html"><i class="fas fa-cash-register"></i> POS</a></li>
            <li><a href="orders.html"><i class="fas fa-list"></i> Orders</a></li>
            <li><a href="kds.html"><i class="fas fa-utensils"></i> ChefOS Line</a></li>
          </ul>
        </div>
        
        <div class="nav-section">
          <h3>Management</h3>
          <ul class="nav-links">
            <li><a href="inventory.html"><i class="fas fa-boxes"></i> ChefOS Stock</a></li>
            <li><a href="reports.html" class="active"><i class="fas fa-chart-bar"></i> ChefOS Insights</a></li>
            <li><a href="settings.html"><i class="fas fa-cog"></i> Settings</a></li>
          </ul>
        </div>
      </div>
      
      <!-- SETTINGS PANEL -->
      <div class="settings-panel">
        <div class="theme-toggle">
          <span><i class="fas fa-moon"></i> Dark Mode</span>
          <label class="toggle-switch">
            <input type="checkbox" id="themeToggle">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
      
      <!-- HELP CENTER -->
      <div class="help-center">
        <h4><i class="fas fa-life-ring"></i> Help Center</h4>
        <div class="contact-info">
          <a href="mailto:dereck@dereckmungoriwo.online">
            <i class="fas fa-envelope"></i> dereck@dereckmungoriwo.online
          </a>
          <a href="https://wa.me/27717184048" target="_blank">
            <i class="fab fa-whatsapp"></i> +27 71 718 4048
          </a>
          <div>
            <i class="fas fa-clock"></i> 24/7 Support
          </div>
        </div>
      </div>
      
      <a href="login.html" class="logout-btn">
        <i class="fas fa-sign-out-alt"></i> Logout
      </a>
    </aside>
    
    <main class="main-content">
      <header class="top-bar">
        <div class="header-left">
          <h2 class="app-title">ChefOS Control Panel</h2>
          <p class="header-motto">Precision • Speed • Control</p>
        </div>

        <div class="header-right">
          <div class="time-display" aria-live="polite">
            <svg class="clock-icon" viewBox="0 0 24 24" aria-hidden="true">
              <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2" fill="none"/>
              <path d="M12 7v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <span id="clockText">Loading time...</span>
          </div>

          <div class="user-info">
            <div class="user-avatar" aria-label="User initials">DM</div>
            <div class="user-meta">
              <div class="user-name">Dereck Mungoriwo</div>
              <div class="user-role">Manager</div>
            </div>
          </div>
        </div>
      </header>
      
      <!-- INSIGHTS CONTAINER -->
      <div class="insights-container">
        <!-- DATE RANGE SELECTOR -->
        <div class="date-range-selector">
          <h2><i class="fas fa-chart-line"></i> Business Insights</h2>
          <div class="date-controls">
            <button class="date-btn active" data-range="today">Today</button>
            <button class="date-btn" data-range="week">This Week</button>
            <button class="date-btn" data-range="month">This Month</button>
            <button class="date-btn" data-range="year">This Year</button>
            <div class="custom-range">
              <input type="date" id="startDate">
              <span>to</span>
              <input type="date" id="endDate">
              <button id="applyCustomRange">Apply</button>
            </div>
          </div>
        </div>

        <!-- KEY METRICS -->
        <div class="key-metrics">
          <div class="metric-card revenue">
            <div class="metric-icon">
              <i class="fas fa-money-bill-wave"></i>
            </div>
            <div class="metric-info">
              <h3 id="totalRevenue">R0.00</h3>
              <p>Total Revenue</p>
              <div class="metric-change" id="revenueChange">
                <i class="fas fa-arrow-up"></i> 0%
              </div>
            </div>
          </div>
          
          <div class="metric-card orders">
            <div class="metric-icon">
              <i class="fas fa-shopping-cart"></i>
            </div>
            <div class="metric-info">
              <h3 id="totalOrders">0</h3>
              <p>Total Orders</p>
              <div class="metric-change" id="ordersChange">
                <i class="fas fa-arrow-up"></i> 0%
              </div>
            </div>
          </div>
          
          <div class="metric-card average">
            <div class="metric-icon">
              <i class="fas fa-receipt"></i>
            </div>
            <div class="metric-info">
              <h3 id="averageOrder">R0.00</h3>
              <p>Average Order</p>
              <div class="metric-change" id="averageChange">
                <i class="fas fa-arrow-up"></i> 0%
              </div>
            </div>
          </div>
          
          <div class="metric-card tables">
            <div class="metric-icon">
              <i class="fas fa-utensils"></i>
            </div>
            <div class="metric-info">
              <h3 id="busiestTable">N/A</h3>
              <p>Busiest Table</p>
              <div class="metric-change">
                <span id="tableOrders">0 orders</span>
              </div>
            </div>
          </div>
        </div>

        <!-- CHARTS ROW -->
        <div class="charts-row">
          <div class="chart-card">
            <div class="chart-header">
              <h3><i class="fas fa-chart-bar"></i> Revenue Trend</h3>
              <select id="revenueChartType">
                <option value="line">Line Chart</option>
                <option value="bar">Bar Chart</option>
              </select>
            </div>
            <div class="chart-container">
              <canvas id="revenueChart"></canvas>
            </div>
          </div>
          
          <div class="chart-card">
            <div class="chart-header">
              <h3><i class="fas fa-chart-pie"></i> Sales by Category</h3>
            </div>
            <div class="chart-container">
              <canvas id="categoryChart"></canvas>
            </div>
          </div>
        </div>

        <!-- TOP SELLING ITEMS -->
        <div class="top-items-section">
          <div class="section-header">
            <h3><i class="fas fa-star"></i> Top Selling Items</h3>
            <select id="topItemsPeriod">
              <option value="today">Today</option>
              <option value="week">This Week</option>
              <option value="month">This Month</option>
            </select>
          </div>
          <div class="top-items-list" id="topItemsList">
            <!-- Top items will be loaded here -->
          </div>
        </div>

        <!-- SALES TABLE -->
        <div class="sales-table-section">
          <div class="section-header">
            <h3><i class="fas fa-table"></i> Detailed Sales Report</h3>
            <button class="export-btn" id="exportBtn">
              <i class="fas fa-download"></i> Export Report
            </button>
          </div>
          <div class="sales-table-container">
            <table class="sales-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Order ID</th>
                  <th>Table</th>
                  <th>Items</th>
                  <th>Total</th>
                  <th>Status</th>
                  <th>Duration</th>
                </tr>
              </thead>
              <tbody id="salesTableBody">
                <!-- Sales data will be loaded here -->
              </tbody>
            </table>
            
            <div id="no-sales" style="display: none; text-align: center; padding: 40px;">
              <i class="fas fa-chart-line fa-3x" style="color: var(--gray);"></i>
              <h3 style="margin: 20px 0 10px; color: var(--gray);">No Sales Data</h3>
              <p style="color: var(--gray);">Sales data will appear here once orders are placed.</p>
            </div>
          </div>
        </div>

        <!-- SUMMARY CARDS -->
        <div class="summary-cards">
          <div class="summary-card peak-hours">
            <h4><i class="fas fa-clock"></i> Peak Hours</h4>
            <div class="peak-list" id="peakHours">
              <!-- Peak hours will be loaded here -->
            </div>
          </div>
          
          <div class="summary-card popular-tables">
            <h4><i class="fas fa-table"></i> Popular Tables</h4>
            <div class="table-list" id="popularTables">
              <!-- Popular tables will be loaded here -->
            </div>
          </div>
          
          <div class="summary-card low-stock">
            <h4><i class="fas fa-exclamation-triangle"></i> Low Stock Alert</h4>
            <div class="stock-list" id="lowStockItems">
              <!-- Low stock items will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- REPORT MODAL -->
  <div id="reportModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-file-export"></i> Export Report</h3>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="export-options">
          <div class="option-card">
            <i class="fas fa-file-excel"></i>
            <h4>Excel Format</h4>
            <p>Download as .xlsx file</p>
            <button class="export-format-btn" data-format="excel">
              <i class="fas fa-download"></i> Export
            </button>
          </div>
          
          <div class="option-card">
            <i class="fas fa-file-pdf"></i>
            <h4>PDF Format</h4>
            <p>Download as .pdf file</p>
            <button class="export-format-btn" data-format="pdf">
              <i class="fas fa-download"></i> Export
            </button>
          </div>
          
          <div class="option-card">
            <i class="fas fa-file-csv"></i>
            <h4>CSV Format</h4>
            <p>Download as .csv file</p>
            <button class="export-format-btn" data-format="csv">
              <i class="fas fa-download"></i> Export
            </button>
          </div>
        </div>
        
        <div class="date-range-summary">
          <h4>Report Period</h4>
          <p id="reportPeriod">Today</p>
        </div>
      </div>
    </div>
  </div>

  <script src="assets/js/reports.js"></script>

  <script>
    // Theme Toggle with better error handling
    (function initializeTheme() {
      const themeToggle = document.getElementById('themeToggle');
      if (!themeToggle) return;
      
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      
      if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
        document.body.classList.add('dark-theme');
        themeToggle.checked = true;
      }
      
      themeToggle.addEventListener('change', function() {
        if (this.checked) {
          document.body.classList.add('dark-theme');
          localStorage.setItem('theme', 'dark');
        } else {
          document.body.classList.remove('dark-theme');
          localStorage.setItem('theme', 'light');
        }
      });
    })();

    // Update Time
    function updateClock() {
      const clockText = document.getElementById('clockText');
      if (!clockText) return;
      
      const now = new Date();
      const options = {
        weekday: 'short',
        day: '2-digit',
        month: 'short',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      };
      
      try {
        clockText.textContent = now.toLocaleString('en-US', options);
      } catch (error) {
        console.error('Error updating clock:', error);
        clockText.textContent = now.toISOString().split('T')[0] + ' ' + now.toTimeString().split(' ')[0];
      }
    }
    
    // Initialize clock immediately and set interval
    updateClock();
    const clockInterval = setInterval(updateClock, 1000);

    // Initialize Reports with proper cleanup
    document.addEventListener('DOMContentLoaded', () => {
      try {
        initReports();
      } catch (error) {
        console.error('Failed to initialize reports:', error);
        showError('Unable to load reports. Please refresh the page.');
      }
    });

    function showError(message) {
      const container = document.querySelector('.insights-container');
      if (container) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.innerHTML = `
          <i class="fas fa-exclamation-triangle"></i>
          <p>${message}</p>
        `;
        container.prepend(errorDiv);
      }
    }

    function initReports() {
      // DOM Elements
      const dateButtons = document.querySelectorAll('.date-btn');
      const startDateInput = document.getElementById('startDate');
      const endDateInput = document.getElementById('endDate');
      const applyCustomRangeBtn = document.getElementById('applyCustomRange');
      const exportBtn = document.getElementById('exportBtn');
      const topItemsPeriodSelect = document.getElementById('topItemsPeriod');
      const revenueChartTypeSelect = document.getElementById('revenueChartType');
      const reportModal = document.getElementById('reportModal');
      const modalCloseButtons = document.querySelectorAll('.modal-close');
      
      // Validate required elements
      if (!startDateInput || !endDateInput || !reportModal) {
        throw new Error('Required DOM elements not found');
      }
      
      // State management
      let revenueChart = null;
      let categoryChart = null;
      let currentRange = 'today';
      let startDate = new Date();
      let endDate = new Date();
      
      // Utility functions
      function formatCurrency(amount) {
        return `R${parseFloat(amount).toFixed(2)}`;
      }
      
      function safeParseJSON(key, defaultValue = []) {
        try {
          const data = localStorage.getItem(key);
          return data ? JSON.parse(data) : defaultValue;
        } catch (error) {
          console.error(`Error parsing ${key}:`, error);
          return defaultValue;
        }
      }
      
      // Initialize date inputs
      const today = new Date();
      startDateInput.valueAsDate = today;
      endDateInput.valueAsDate = today;
      startDateInput.max = today.toISOString().split('T')[0];
      endDateInput.max = today.toISOString().split('T')[0];
      
      // Core functions
      function initializeCharts() {
        try {
          const revenueCtx = document.getElementById('revenueChart')?.getContext('2d');
          const categoryCtx = document.getElementById('categoryChart')?.getContext('2d');
          
          if (!revenueCtx || !categoryCtx) {
            throw new Error('Chart canvases not found');
          }
          
          revenueChart = new Chart(revenueCtx, {
            type: 'line',
            data: {
              labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
              datasets: [{
                label: 'Revenue',
                data: [1200, 1900, 1500, 2300, 2900, 3400, 2800],
                borderColor: '#1e6f5c',
                backgroundColor: 'rgba(30, 111, 92, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: (context) => `Revenue: ${formatCurrency(context.raw)}`
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: (value) => formatCurrency(value)
                  }
                }
              }
            }
          });
          
          categoryChart = new Chart(categoryCtx, {
            type: 'doughnut',
            data: {
              labels: ['Breakfast', 'Main Course', 'Salads', 'Desserts', 'Drinks'],
              datasets: [{
                data: [25, 35, 15, 15, 10],
                backgroundColor: [
                  '#1e6f5c',
                  '#28a085',
                  '#ffc107',
                  '#e74c3c',
                  '#007bff'
                ],
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                  callbacks: {
                    label: (context) => `${context.label}: ${context.raw}%`
                  }
                }
              }
            }
          });
        } catch (error) {
          console.error('Failed to initialize charts:', error);
          throw error;
        }
      }
      
      function setDateRange(range) {
        currentRange = range;
        const today = new Date();
        
        // Update button states
        dateButtons.forEach(btn => {
          btn.classList.toggle('active', btn.getAttribute('data-range') === range);
        });
        
        // Calculate date range
        const rangeStart = new Date(today);
        switch(range) {
          case 'today':
            startDate = new Date(today);
            endDate = new Date(today);
            break;
          case 'week':
            startDate = new Date(today.setDate(today.getDate() - 7));
            endDate = new Date();
            break;
          case 'month':
            startDate = new Date(today.setMonth(today.getMonth() - 1));
            endDate = new Date();
            break;
          case 'year':
            startDate = new Date(today.setFullYear(today.getFullYear() - 1));
            endDate = new Date();
            break;
          default:
            // Keep existing dates for custom range
            break;
        }
        
        // Update date inputs
        startDateInput.valueAsDate = startDate;
        endDateInput.valueAsDate = endDate;
        
        // Load data
        loadReportData();
      }
      
      function filterOrdersByDate(orders) {
        return orders.filter(order => {
          try {
            const orderDate = new Date(order.fullTimestamp || order.orderTime);
            return orderDate >= startDate && orderDate <= endDate;
          } catch (error) {
            console.error('Error parsing order date:', error);
            return false;
          }
        });
      }
      
      function calculateMetrics(orders) {
        // Revenue
        const totalRevenue = orders.reduce((sum, order) => {
          return sum + (parseFloat(order.total) || 0);
        }, 0);
        document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
        
        // Order count
        document.getElementById('totalOrders').textContent = orders.length;
        
        // Average order value
        const averageOrder = orders.length > 0 ? totalRevenue / orders.length : 0;
        document.getElementById('averageOrder').textContent = formatCurrency(averageOrder);
        
        // Busiest table
        const tableCounts = {};
        orders.forEach(order => {
          const table = order.table || 'Unknown';
          tableCounts[table] = (tableCounts[table] || 0) + 1;
        });
        
        let busiestTable = 'N/A';
        let maxOrders = 0;
        Object.entries(tableCounts).forEach(([table, count]) => {
          if (count > maxOrders) {
            maxOrders = count;
            busiestTable = table;
          }
        });
        
        document.getElementById('busiestTable').textContent = `Table ${busiestTable}`;
        document.getElementById('tableOrders').textContent = `${maxOrders} orders`;
        
        // Placeholder for change calculations (would require historical data)
        const revenueChange = orders.length > 0 ? 12.5 : 0;
        const ordersChange = orders.length > 0 ? 8.3 : 0;
        const averageChange = orders.length > 0 ? 4.2 : 0;
        
        document.getElementById('revenueChange').innerHTML = 
          `<i class="fas fa-arrow-up"></i> ${revenueChange.toFixed(1)}%`;
        document.getElementById('ordersChange').innerHTML = 
          `<i class="fas fa-arrow-up"></i> ${ordersChange.toFixed(1)}%`;
        document.getElementById('averageChange').innerHTML = 
          `<i class="fas fa-arrow-up"></i> ${averageChange.toFixed(1)}%`;
      }
      
      function updateTopItems(orders) {
        const itemSales = {};
        
        // Aggregate item sales
        orders.forEach(order => {
          (order.items || []).forEach(item => {
            const name = item.name || 'Unknown Item';
            const qty = parseInt(item.qty) || 0;
            const price = parseFloat(item.price) || 0;
            
            if (!itemSales[name]) {
              itemSales[name] = { quantity: 0, revenue: 0 };
            }
            itemSales[name].quantity += qty;
            itemSales[name].revenue += price * qty;
          });
        });
        
        // Sort and get top 5
        const topItems = Object.entries(itemSales)
          .map(([name, data]) => ({
            name,
            quantity: data.quantity,
            revenue: data.revenue
          }))
          .sort((a, b) => b.quantity - a.quantity)
          .slice(0, 5);
        
        const topItemsList = document.getElementById('topItemsList');
        if (!topItemsList) return;
        
        // Clear and update
        topItemsList.innerHTML = '';
        
        if (topItems.length === 0) {
          topItemsList.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-utensils"></i>
              <p>No sales data for this period</p>
            </div>
          `;
          return;
        }
        
        // Find max quantity for percentage calculation
        const maxQuantity = Math.max(...topItems.map(item => item.quantity));
        
        topItems.forEach((item, index) => {
          const itemCard = document.createElement('div');
          itemCard.className = 'top-item-card';
          const percentage = maxQuantity > 0 ? (item.quantity / maxQuantity) * 100 : 0;
          
          itemCard.innerHTML = `
            <div class="item-rank">${index + 1}</div>
            <div class="item-info">
              <h4>${escapeHTML(item.name)}</h4>
              <p>${item.quantity} sold • ${formatCurrency(item.revenue)} revenue</p>
            </div>
            <div class="item-stats">
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${percentage.toFixed(1)}%"></div>
              </div>
            </div>
          `;
          topItemsList.appendChild(itemCard);
        });
      }
      
      function escapeHTML(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
      
      function updateSalesTable(orders) {
        const salesTableBody = document.getElementById('salesTableBody');
        const noSalesMessage = document.getElementById('no-sales');
        
        if (!salesTableBody || !noSalesMessage) return;
        
        salesTableBody.innerHTML = '';
        
        if (orders.length === 0) {
          noSalesMessage.style.display = 'block';
          return;
        }
        
        noSalesMessage.style.display = 'none';
        
        // Sort by most recent first
        orders.sort((a, b) => {
          const dateA = new Date(a.fullTimestamp || a.orderTime);
          const dateB = new Date(b.fullTimestamp || b.orderTime);
          return dateB - dateA;
        });
        
        // Populate table
        orders.forEach(order => {
          const orderDate = new Date(order.fullTimestamp || order.orderTime);
          const dateString = orderDate.toLocaleDateString();
          const timeString = orderDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
          
          // Calculate duration (placeholder - would need actual timing data)
          const duration = '45 min';
          
          // Status badge
          const status = (order.status || 'pending').toLowerCase();
          let statusBadge = '';
          switch(status) {
            case 'pending':
              statusBadge = '<span class="status-badge status-pending">Pending</span>';
              break;
            case 'preparing':
              statusBadge = '<span class="status-badge status-preparing">Preparing</span>';
              break;
            case 'ready':
              statusBadge = '<span class="status-badge status-ready">Ready</span>';
              break;
            case 'completed':
              statusBadge = '<span class="status-badge status-completed">Completed</span>';
              break;
            default:
              statusBadge = `<span class="status-badge">${status}</span>`;
          }
          
          const totalItems = (order.items || []).reduce((sum, item) => sum + (parseInt(item.qty) || 0), 0);
          const orderId = order.id ? `#${order.id.toString().slice(-6)}` : '#N/A';
          
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${dateString}<br><small>${timeString}</small></td>
            <td>${orderId}</td>
            <td>Table ${order.table || 'N/A'}</td>
            <td>${totalItems} items</td>
            <td><strong>${formatCurrency(order.total)}</strong></td>
            <td>${statusBadge}</td>
            <td>${duration}</td>
          `;
          salesTableBody.appendChild(row);
        });
      }
      
      function updateSummaryCards(orders) {
        // Peak hours
        const hourCounts = {};
        orders.forEach(order => {
          try {
            const hour = new Date(order.fullTimestamp || order.orderTime).getHours();
            hourCounts[hour] = (hourCounts[hour] || 0) + 1;
          } catch (error) {
            console.error('Error extracting hour from order:', error);
          }
        });
        
        const peakHours = Object.entries(hourCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 3)
          .map(([hour, count]) => ({
            hour: `${hour.toString().padStart(2, '0')}:00`,
            orders: count
          }));
        
        const peakHoursEl = document.getElementById('peakHours');
        if (peakHoursEl) {
          peakHoursEl.innerHTML = peakHours.length > 0 
            ? peakHours.map(p => `
                <div class="peak-hour">
                  <span>${p.hour}</span>
                  <span>${p.orders} orders</span>
                </div>
              `).join('')
            : '<p class="empty-text">No data</p>';
        }
        
        // Popular tables
        const tableCounts = {};
        orders.forEach(order => {
          const table = order.table || 'Unknown';
          tableCounts[table] = (tableCounts[table] || 0) + 1;
        });
        
        const popularTables = Object.entries(tableCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 3)
          .map(([table, count]) => ({ table, count }));
        
        const popularTablesEl = document.getElementById('popularTables');
        if (popularTablesEl) {
          popularTablesEl.innerHTML = popularTables.length > 0 
            ? popularTables.map(t => `
                <div class="popular-table">
                  <span>Table ${t.table}</span>
                  <span>${t.count} orders</span>
                </div>
              `).join('')
            : '<p class="empty-text">No data</p>';
        }
        
        // Low stock items
        const inventory = safeParseJSON('chefos_inventory_detailed', []);
        const lowStock = inventory
          .filter(item => {
            const current = parseInt(item.currentStock) || 0;
            const min = parseInt(item.minStock) || 0;
            return current <= min;
          })
          .slice(0, 3);
        
        const lowStockEl = document.getElementById('lowStockItems');
        if (lowStockEl) {
          lowStockEl.innerHTML = lowStock.length > 0 
            ? lowStock.map(item => `
                <div class="low-stock-item">
                  <span>${escapeHTML(item.name)}</span>
                  <span>${item.currentStock} ${item.unit || 'units'} left</span>
                </div>
              `).join('')
            : '<p class="empty-text">All items in stock</p>';
        }
      }
      
      function loadReportData() {
        try {
          // Load orders from localStorage
          const pendingOrders = safeParseJSON('chefos_orders');
          const completedOrders = safeParseJSON('chefos_completed_orders');
          const allOrders = [...pendingOrders, ...completedOrders];
          
          // Filter by date range
          const filteredOrders = filterOrdersByDate(allOrders);
          
          // Update all sections
          calculateMetrics(filteredOrders);
          updateTopItems(filteredOrders);
          updateSalesTable(filteredOrders);
          updateSummaryCards(filteredOrders);
          
          // Update charts if they exist
          if (revenueChart) {
            const chartType = revenueChartTypeSelect?.value || 'line';
            revenueChart.config.type = chartType;
            revenueChart.update('none');
          }
          
          if (categoryChart) {
            categoryChart.update('none');
          }
        } catch (error) {
          console.error('Error loading report data:', error);
          showError('Failed to load report data. Please try again.');
        }
      }
      
      function exportReport(format) {
        const messages = {
          excel: 'Excel report is being generated...',
          pdf: 'PDF report is being generated...',
          csv: 'CSV file is being downloaded...'
        };
        
        const message = messages[format] || 'Report is being generated...';
        alert(`${message}\n\nIn a production system, this would generate a ${format.toUpperCase()} file.`);
        reportModal.style.display = 'none';
      }
      
      // Event listeners
      function setupEventListeners() {
        // Date range buttons
        dateButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            setDateRange(btn.getAttribute('data-range'));
          });
        });
        
        // Custom date range
        if (applyCustomRangeBtn) {
          applyCustomRangeBtn.addEventListener('click', () => {
            const start = new Date(startDateInput.value);
            const end = new Date(endDateInput.value);
            
            if (isNaN(start.getTime()) || isNaN(end.getTime())) {
              alert('Please select valid dates');
              return;
            }
            
            if (start > end) {
              alert('Start date must be before end date');
              return;
            }
            
            startDate = start;
            endDate = end;
            currentRange = 'custom';
            
            // Update button states
            dateButtons.forEach(btn => btn.classList.remove('active'));
            loadReportData();
          });
        }
        
        // Export button
        if (exportBtn) {
          exportBtn.addEventListener('click', () => {
            const periodText = currentRange === 'custom' 
              ? `${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}`
              : currentRange.charAt(0).toUpperCase() + currentRange.slice(1);
            
            document.getElementById('reportPeriod').textContent = periodText;
            reportModal.style.display = 'flex';
          });
        }
        
        // Export format buttons
        document.querySelectorAll('.export-format-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            exportReport(btn.getAttribute('data-format'));
          });
        });
        
        // Modal close buttons
        modalCloseButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            reportModal.style.display = 'none';
          });
        });
        
        // Close modal on outside click
        window.addEventListener('click', (event) => {
          if (event.target === reportModal) {
            reportModal.style.display = 'none';
          }
        });
        
        // Period select change
        if (topItemsPeriodSelect) {
          topItemsPeriodSelect.addEventListener('change', loadReportData);
        }
        
        // Chart type change
        if (revenueChartTypeSelect) {
          revenueChartTypeSelect.addEventListener('change', loadReportData);
        }
        
        // Prevent form submission
        document.querySelectorAll('input[type="date"]').forEach(input => {
          input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              loadReportData();
            }
          });
        });
      }
      
      // Cleanup function
      function cleanup() {
        if (revenueChart) {
          revenueChart.destroy();
        }
        if (categoryChart) {
          categoryChart.destroy();
        }
        clearInterval(clockInterval);
      }
      
      // Initialize
      initializeCharts();
      setupEventListeners();
      setDateRange('today');
      
      // Handle page unload
      window.addEventListener('beforeunload', cleanup);
      
      // Return cleanup function for manual control
      return cleanup;
    }
  </script>
</body>
</html>
