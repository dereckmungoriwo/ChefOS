<script>
function loadOrders() {
  const orders = JSON.parse(localStorage.getItem('chefos_orders')) || [];

  const pendingCol = document.getElementById('pending-orders');
  const preparingCol = document.getElementById('preparing-orders');
  const readyCol = document.getElementById('ready-orders');

  pendingCol.innerHTML = '';
  preparingCol.innerHTML = '';
  readyCol.innerHTML = '';

  if (orders.length === 0) {
    pendingCol.innerHTML =
      '<div class="text-center p-20"><i class="fas fa-inbox fa-3x" style="color: var(--gray);"></i><p class="mt-20">No active orders</p></div>';
    return;
  }

  // Sort oldest first
  orders.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

  orders.forEach(order => {
    const status = (order.status || '').toLowerCase();
    if (!['pending','preparing','ready'].includes(status)) return;

    const orderCard = document.createElement('div');
    orderCard.className = `order-card ${status}`;

    const time = new Date(order.timestamp);
    const timeDisplay = isNaN(time) ? '--:--' : time.toLocaleTimeString();

    orderCard.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <strong>#${order.id}</strong>
        <span class="status-badge status-${status}">${status.toUpperCase()}</span>
      </div>
      <div style="font-size:14px;margin-bottom:10px;">
        <div><i class="fas fa-table"></i> Table ${order.table}</div>
        <div><i class="fas fa-clock"></i> ${timeDisplay}</div>
      </div>
      <div style="font-size:13px;border-top:1px solid var(--gray-light);padding-top:10px;">
        ${(order.items || []).map(item => `<div>${item.qty}x ${item.name}</div>`).join('')}
      </div>
      <div style="margin-top:10px;display:flex;gap:10px;">
        ${status === 'pending'
          ? `<button class="mark-preparing" data-id="${order.id}" style="background:var(--primary);color:white;border:none;padding:8px 15px;border-radius:5px;cursor:pointer;">Start</button>`
          : ''}
        ${status === 'preparing'
          ? `<button class="mark-ready" data-id="${order.id}" style="background:#28a745;color:white;border:none;padding:8px 15px;border-radius:5px;cursor:pointer;">Ready</button>`
          : ''}
      </div>
    `;

    if (status === 'pending') pendingCol.appendChild(orderCard);
    if (status === 'preparing') preparingCol.appendChild(orderCard);
    if (status === 'ready') readyCol.appendChild(orderCard);
  });
}

document.addEventListener('click', function(e) {
  const id = e.target.dataset.id;
  if (!id) return;

  if (e.target.classList.contains('mark-preparing')) {
    updateOrderStatus(id, 'preparing');
  }

  if (e.target.classList.contains('mark-ready')) {
    updateOrderStatus(id, 'ready');
  }
});

function updateOrderStatus(orderId, newStatus) {
  let orders = JSON.parse(localStorage.getItem('chefos_orders')) || [];
  const index = orders.findIndex(o => o.id === orderId);
  if (index === -1) return;

  orders[index].status = newStatus;
  localStorage.setItem('chefos_orders', JSON.stringify(orders));
  loadOrders();
}

/* SAFE INTERVALS */
if (!window.kdsIntervalSet) {
  window.kdsIntervalSet = true;
  loadOrders();
  setInterval(loadOrders, 5000);
}

/* TIME DISPLAY */
function updateTime() {
  const now = new Date();
  const options = {
    weekday:'long', year:'numeric', month:'long', day:'numeric',
    hour:'2-digit', minute:'2-digit', hour12:true
  };
  const el = document.getElementById('currentTime');
  if (el) el.textContent = now.toLocaleDateString('en-US', options);
}

updateTime();
if (!window.timeIntervalSet) {
  window.timeIntervalSet = true;
  setInterval(updateTime, 60000);
}
</script>
